<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>WARP 作为科学上网备用手段 - Evilmass</title><meta name=description content="About EnjoyIt Theme"><meta property="og:title" content="WARP 作为科学上网备用手段"><meta property="og:description" content="梯子爆炸 前几天经历过一次两个机场同时失效的情况，期间拿 Cloudflare WARP 客户端暂时顶过去。
梯子这东西日常使用感受不到好处，一旦所有梯子同时失效只能用灾难来形容。
虽然 Cloudflare 早几年被玩坏了，但是作为一个备用手段绰绰有余。
APP 端 ZeroTrust 验证失败的绕过方法 在 Issue 区看到 AndroidStudio 抓包获取 Teams ID 的方法，尝试了一遍发现没什么必要：手动配置更快。
但手机端在验证的最后一步提示失败，挂梯子也无法解决。 在 Windows 留意到有一个 DOH 网关的字样。虽然 warp-cli set-gateway 是制定官方服务器作 DNS 查询，填到手机上却自动激活了 ZeroTrust。 WRAP 配置 ZeroTrust 的教程一搜就有：滥用 Cloudflare ZeroTrust WARP 科学上网。
安装好 Cloudflare Windows Desktop Client 后开启本地代理，往 Clash 添加一个 Socks5 服务器即可。
Clash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 mixed-port: 7890 # Linux 和 macOS 的 redir 代理端口 redir-port: 7892 # 允许局域网的连接 allow-lan: true # 规则模式：Rule（规则） / Global（全局代理）/ Direct（全局直连） mode: rule # 设置日志输出级别 (默认级别：silent，即不输出任何内容，以避免因日志内容过大而导致程序内存溢出）。 # 5 个级别：silent / info / warning / error / debug。级别越高日志输出量越大，越倾向于调试，若需要请自行开启。 log-level: info # Clash 的 RESTful API external-controller: '0."><meta property="og:type" content="article"><meta property="og:url" content="https://evilmass.github.io/posts/warp/"><meta property="og:image" content="https://evilmass.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-11T11:11:20+08:00"><meta property="article:modified_time" content="2023-07-30T18:06:28+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://evilmass.github.io/logo.png"><meta name=twitter:title content="WARP 作为科学上网备用手段"><meta name=twitter:description content="梯子爆炸 前几天经历过一次两个机场同时失效的情况，期间拿 Cloudflare WARP 客户端暂时顶过去。
梯子这东西日常使用感受不到好处，一旦所有梯子同时失效只能用灾难来形容。
虽然 Cloudflare 早几年被玩坏了，但是作为一个备用手段绰绰有余。
APP 端 ZeroTrust 验证失败的绕过方法 在 Issue 区看到 AndroidStudio 抓包获取 Teams ID 的方法，尝试了一遍发现没什么必要：手动配置更快。
但手机端在验证的最后一步提示失败，挂梯子也无法解决。 在 Windows 留意到有一个 DOH 网关的字样。虽然 warp-cli set-gateway 是制定官方服务器作 DNS 查询，填到手机上却自动激活了 ZeroTrust。 WRAP 配置 ZeroTrust 的教程一搜就有：滥用 Cloudflare ZeroTrust WARP 科学上网。
安装好 Cloudflare Windows Desktop Client 后开启本地代理，往 Clash 添加一个 Socks5 服务器即可。
Clash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 mixed-port: 7890 # Linux 和 macOS 的 redir 代理端口 redir-port: 7892 # 允许局域网的连接 allow-lan: true # 规则模式：Rule（规则） / Global（全局代理）/ Direct（全局直连） mode: rule # 设置日志输出级别 (默认级别：silent，即不输出任何内容，以避免因日志内容过大而导致程序内存溢出）。 # 5 个级别：silent / info / warning / error / debug。级别越高日志输出量越大，越倾向于调试，若需要请自行开启。 log-level: info # Clash 的 RESTful API external-controller: '0."><meta name=application-name content="Evilmass"><meta name=apple-mobile-web-app-title content="Evilmass"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://evilmass.github.io/posts/warp/><link rel=prev href=https://evilmass.github.io/posts/raspbot/><link rel=next href=https://evilmass.github.io/posts/%E5%86%99%E4%BD%9C%E6%84%8F%E4%B9%89/><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.54bca96f57f18a4b99114762cf3c97a5b499591019cd13f1a0c99d616a3867fd.css integrity="sha256-VLypb1fxikuZEUdizzyXpbSZWRAZzRPxoMmdYWo4Z/0="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"WARP 作为科学上网备用手段","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/evilmass.github.io\/posts\/warp\/"},"image":["https:\/\/evilmass.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"warp, zerotrust, wireguard, clash, raspberry","wordcount":1191,"url":"https:\/\/evilmass.github.io\/posts\/warp\/","datePublished":"2022-08-11T11:11:20+08:00","dateModified":"2023-07-30T18:06:28+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/evilmass.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"Evilmass"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Evilmass><span class=header-title-pre><i class='fas fa-heart fa-fw'></i></span>Evilmass</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Evilmass><span class=header-title-pre><i class='fas fa-heart fa-fw'></i></span>Evilmass</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">WARP 作为科学上网备用手段</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Evilmass</a></span>&nbsp;<span class=post-category>included in <a href=/categories/%E5%90%84%E7%A7%8D%E9%85%8D%E7%BD%AE/><i class="far fa-folder fa-fw"></i>各种配置</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-08-11>2022-08-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1191 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;<i class="fas fa-eye fa-fw"></i>&nbsp;
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> times read </span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#梯子爆炸>梯子爆炸</a></li><li><a href=#app-端-zerotrust-验证失败的绕过方法>APP 端 ZeroTrust 验证失败的绕过方法</a></li><li><a href=#wrap>WRAP</a></li><li><a href=#clash>Clash</a></li><li><a href=#待解决的问题>待解决的问题</a><ul><li><a href=#复制-23pb-流量-bug>复制 23PB 流量 bug</a></li><li><a href=#warp-cli>warp-cli</a></li><li><a href=#wireproxy>wireproxy</a></li></ul></li><li><a href=#全自动优选-endpoint>全自动优选 Endpoint</a></li></ul></nav></div></div><div class=content id=content><h2 id=梯子爆炸>梯子爆炸</h2><p>前几天经历过一次两个机场同时失效的情况，期间拿 Cloudflare WARP 客户端暂时顶过去。</p><p><strong>梯子这东西日常使用感受不到好处，一旦所有梯子同时失效只能用灾难来形容。</strong></p><p>虽然 Cloudflare 早几年被玩坏了，但是作为一个备用手段绰绰有余。</p><h2 id=app-端-zerotrust-验证失败的绕过方法>APP 端 ZeroTrust 验证失败的绕过方法</h2><p>在 Issue 区看到 AndroidStudio 抓包获取 Teams ID 的方法，尝试了一遍发现没什么必要：手动配置更快。</p><p>但手机端在验证的最后一步提示失败，挂梯子也无法解决。
<img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/tuR5ybsF3PEUlVh.jpg data-srcset="https://s2.loli.net/2023/01/21/tuR5ybsF3PEUlVh.jpg, https://s2.loli.net/2023/01/21/tuR5ybsF3PEUlVh.jpg 1.5x, https://s2.loli.net/2023/01/21/tuR5ybsF3PEUlVh.jpg 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/tuR5ybsF3PEUlVh.jpg title="验证 ZeroTrust 失败"></p><p>在 Windows 留意到有一个 DOH 网关的字样。虽然 <code>warp-cli set-gateway</code> 是制定官方服务器作 DNS 查询，填到手机上却自动激活了 ZeroTrust。
<img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/9Swy6TjzQ1PiAMH.png data-srcset="https://s2.loli.net/2023/01/21/9Swy6TjzQ1PiAMH.png, https://s2.loli.net/2023/01/21/9Swy6TjzQ1PiAMH.png 1.5x, https://s2.loli.net/2023/01/21/9Swy6TjzQ1PiAMH.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/9Swy6TjzQ1PiAMH.png title=dns-gatewary></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/GnOL1PICqo8hADs.png data-srcset="https://s2.loli.net/2023/01/21/GnOL1PICqo8hADs.png, https://s2.loli.net/2023/01/21/GnOL1PICqo8hADs.png 1.5x, https://s2.loli.net/2023/01/21/GnOL1PICqo8hADs.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/GnOL1PICqo8hADs.png title=填写子域></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/GeFWK3NdLIHszoT.jpg data-srcset="https://s2.loli.net/2023/01/21/GeFWK3NdLIHszoT.jpg, https://s2.loli.net/2023/01/21/GeFWK3NdLIHszoT.jpg 1.5x, https://s2.loli.net/2023/01/21/GeFWK3NdLIHszoT.jpg 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/GeFWK3NdLIHszoT.jpg title=开启ZeroTrust成功></p><h2 id=wrap>WRAP</h2><p>配置 ZeroTrust 的教程一搜就有：<a href=https://y4er.com/posts/cloudflare-zerotrust-proxy target=_blank rel="noopener noreferrer">滥用 Cloudflare ZeroTrust WARP 科学上网</a>。</p><p>安装好 Cloudflare Windows Desktop Client 后开启本地代理，往 Clash 添加一个 Socks5 服务器即可。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/qHZ8YnXlgbWGMSK.png data-srcset="https://s2.loli.net/2023/01/21/qHZ8YnXlgbWGMSK.png, https://s2.loli.net/2023/01/21/qHZ8YnXlgbWGMSK.png 1.5x, https://s2.loli.net/2023/01/21/qHZ8YnXlgbWGMSK.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/qHZ8YnXlgbWGMSK.png title="warp 设置本地代理1"></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/aIxeQyOJMZHp2bS.png data-srcset="https://s2.loli.net/2023/01/21/aIxeQyOJMZHp2bS.png, https://s2.loli.net/2023/01/21/aIxeQyOJMZHp2bS.png 1.5x, https://s2.loli.net/2023/01/21/aIxeQyOJMZHp2bS.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/aIxeQyOJMZHp2bS.png title="warp 设置本地代理2"></p><h2 id=clash>Clash</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>mixed-port</span><span class=p>:</span><span class=w> </span><span class=m>7890</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Linux 和 macOS 的 redir 代理端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>redir-port</span><span class=p>:</span><span class=w> </span><span class=m>7892</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 允许局域网的连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>allow-lan</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 规则模式：Rule（规则） / Global（全局代理）/ Direct（全局直连）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置日志输出级别 (默认级别：silent，即不输出任何内容，以避免因日志内容过大而导致程序内存溢出）。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 5 个级别：silent / info / warning / error / debug。级别越高日志输出量越大，越倾向于调试，若需要请自行开启。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>log-level</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Clash 的 RESTful API</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>external-controller</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.0.0.0:9090&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># RESTful API 的口令</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>secret</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipv6</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.0.0.0:53&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use-hosts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enhanced-mode</span><span class=p>:</span><span class=w> </span><span class=l>fake-ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fake-ip-range</span><span class=p>:</span><span class=w> </span><span class=m>198.18.0.1</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://doh.pub/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fallback</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://1.0.0.1/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://45.11.45.11/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fallback-filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>geoip</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ipcidr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>240.0.0.0</span><span class=l>/4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>proxies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;WARP+&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>socks5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>40000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>proxy-groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;手动选择节点&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;WARP+&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rule-providers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/reject.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>icloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/icloud.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apple</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/apple.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>google</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/google.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/proxy.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>direct</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/direct.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>private</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/private.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>telegramcidr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>ipcidr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/telegramcidr.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cncidr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>ipcidr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/cncidr.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lancidr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>ipcidr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./ruleset/lancidr.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c># 这些是自定义规则，想要的可以继续加。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>DOMAIN-SUFFIX,cloudflareclient.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c># 下面的规则是通过上面的rule-provider来确定的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,private,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,reject,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,icloud,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,apple,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,google,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,proxy,WARP+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,direct,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,lancidr,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,cncidr,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>RULE-SET,telegramcidr,WARP+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>GEOIP,,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>GEOIP,CN,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=l>MATCH,WARP+</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=待解决的问题>待解决的问题</h2><ol><li>ZeroTrust 能提供 50 设备同时在线且不限流量使用，WARP free 与 WARP+ 使用起来也无任何区别，但未来策略是否收紧不好说。</li><li>WARP Client 会根据最近的地理位置选择连接机房（SJC），有些机房（HKG）虽然能连上但是不稳定，甚至完全连不上。</li><li>WARP Linux Client 不支持 ARM 平台，树莓派要走 Wireguard。</li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/jDxpLyol6iJfKzw.png data-srcset="https://s2.loli.net/2023/01/21/jDxpLyol6iJfKzw.png, https://s2.loli.net/2023/01/21/jDxpLyol6iJfKzw.png 1.5x, https://s2.loli.net/2023/01/21/jDxpLyol6iJfKzw.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/jDxpLyol6iJfKzw.png title="不支持 ARM 平台"></p><h3 id=复制-23pb-流量-bug>复制 23PB 流量 bug</h3><p>什么年代了还在传统<a href=https://github.com/Oreomeow/warpplus target=_blank rel="noopener noreferrer">刷推荐流量</a>，直接 <a href=t.me/generatewarpplusbot rel>generatewarpplusbot</a> 生成一个用不完的 key，或者用以下复制 bug。</p><pre><code>备份自己的 key
到 t.me/warpplus 拷贝一个 23PB 的 key
手机更换密钥后可用流量变成 23PB，再切换回自己的 key 会发现 23PB 流量已复制到自己账号下
</code></pre><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/05/24/ewf1AKzPtVp3gkO.png data-srcset="https://s2.loli.net/2023/05/24/ewf1AKzPtVp3gkO.png, https://s2.loli.net/2023/05/24/ewf1AKzPtVp3gkO.png 1.5x, https://s2.loli.net/2023/05/24/ewf1AKzPtVp3gkO.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/05/24/ewf1AKzPtVp3gkO.png title=https://s2.loli.net/2023/05/24/ewf1AKzPtVp3gkO.png></p><h3 id=warp-cli>warp-cli</h3><p>一开始搜<code>切换warp机房</code>得不到有效信息，后面找的 <a href=https://github.com/Windla/WARP-PLUS-HKG target=_blank rel="noopener noreferrer">WARP-PLUS-HKG</a> 也不好用。</p><p>后面在<a href=https://blog.cloudflare.com/announcing-warp-for-linux-and-proxy-mode/ target=_blank rel="noopener noreferrer">官方文档</a>找到相关命令：<code>set-custom-endpoint</code></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/zBqGoNEM8damrQh.png data-srcset="https://s2.loli.net/2023/01/21/zBqGoNEM8damrQh.png, https://s2.loli.net/2023/01/21/zBqGoNEM8damrQh.png 1.5x, https://s2.loli.net/2023/01/21/zBqGoNEM8damrQh.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/zBqGoNEM8damrQh.png title=warp-cli-help></p><p>这里我犯了一个错误，将 <strong>优选 IP</strong> 和 <strong>endpoint IP</strong> 弄混了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>warp-cli set-custom-endpoint 优选IP
</span></span><span class=line><span class=cl><span class=c1># 会报如下错误</span>
</span></span><span class=line><span class=cl>Error: <span class=s2>&#34;Failed to remove Trusted SSID because the SSID was invalid.&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>当时还疑惑优选IP:80|443 端口怎么连不上，后面在 <a href=https://github.com/fscarmen/warp/issues/101 target=_blank rel="noopener noreferrer">Issue</a> 才了解到 endpoint 域名是这个：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>endgate.cloudflareclient.com:2408
</span></span></code></pre></td></tr></table></div></div><p>广州电信在 <code>162.159.192.0</code> 段直连完全连不上，换成 <code>162.159.193.0</code> 即可。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/LYBz7JNeI9Q6WcO.png data-srcset="https://s2.loli.net/2023/01/21/LYBz7JNeI9Q6WcO.png, https://s2.loli.net/2023/01/21/LYBz7JNeI9Q6WcO.png 1.5x, https://s2.loli.net/2023/01/21/LYBz7JNeI9Q6WcO.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/LYBz7JNeI9Q6WcO.png title=连接延迟></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://s2.loli.net/2023/01/21/dRy7fcCsSZ9uTlx.png data-srcset="https://s2.loli.net/2023/01/21/dRy7fcCsSZ9uTlx.png, https://s2.loli.net/2023/01/21/dRy7fcCsSZ9uTlx.png 1.5x, https://s2.loli.net/2023/01/21/dRy7fcCsSZ9uTlx.png 2x" data-sizes=auto alt=https://s2.loli.net/2023/01/21/dRy7fcCsSZ9uTlx.png title=测速></p><h3 id=wireproxy>wireproxy</h3><p>顺着 <a href=https://github.com/fscarmen/warp target=_blank rel="noopener noreferrer">fscarmen/warp</a> 找到 <a href=https://github.com/ViRb3/wgcf/ target=_blank rel="noopener noreferrer">wgcf</a>，导出配置文件后修改 Endpoint 即可用 Wireguard 连上 WARP。</p><p>早期还有批处理改系统路由表分流后利用 Wireguard 科学上网的玩法，后面应对 UDP Qos 还套 fake-tcp，都太 Tricky 了。</p><p>直接替换相应 Endpoint。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Interface]
</span></span><span class=line><span class=cl>PrivateKey =
</span></span><span class=line><span class=cl>Address = 172.16.0.2/32
</span></span><span class=line><span class=cl>Address = 2606:4700:110:8d72:9f99:8ebb:2ebe:8fb9/128
</span></span><span class=line><span class=cl>DNS = 1.1.1.1
</span></span><span class=line><span class=cl>[Peer]
</span></span><span class=line><span class=cl>PublicKey =
</span></span><span class=line><span class=cl>AllowedIPs = 0.0.0.0/0
</span></span><span class=line><span class=cl>AllowedIPs = ::/0
</span></span><span class=line><span class=cl>Endpoint = 162.159.193.1:2408 #engage.cloudflareclient.com:2408
</span></span></code></pre></td></tr></table></div></div><p>在树莓派配置 <a href=https://github.com/fscarmen/warp/blob/main/warp-go.sh target=_blank rel="noopener noreferrer">warp-go.sh</a> 失败后找到 <a href=https://github.com/octeep/wireproxy target=_blank rel="noopener noreferrer">wireproxy</a>，开启本地代理仅需以下配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Interface]
</span></span><span class=line><span class=cl>Address = 172.16.0.2/32
</span></span><span class=line><span class=cl>PrivateKey =
</span></span><span class=line><span class=cl>DNS = 119.29.29.29,8.8.8.8,1.1.1.1,45.11.45.11
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Peer]
</span></span><span class=line><span class=cl>PublicKey =
</span></span><span class=line><span class=cl>Endpoint = 162.159.193.1:2408
</span></span><span class=line><span class=cl>PersistentKeepalive = 25
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Socks5]
</span></span><span class=line><span class=cl>BindAddress = 127.0.0.1:40000
</span></span></code></pre></td></tr></table></div></div><p>但是这种方法挂个后台+自启动也不优雅，将上面的 BindAddress 改为监听 <code>0.0.0.0</code> 即可用 Clash 串联树莓派，作为备用手段不要求速度和延迟。</p><p>Windows 端启动后隐藏窗口的批处理文件写法，只能在任务管理器找到 <code>wireproxy.exe</code> 进程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=s2>&#34;</span><span class=nv>%1</span><span class=s2>&#34;</span><span class=o>==</span><span class=s2>&#34;h&#34;</span> <span class=k>goto</span> <span class=nl>begin</span>
</span></span><span class=line><span class=cl><span class=k>start</span> mshta vbscript:createobject(<span class=s2>&#34;wscript.shell&#34;</span>).run(<span class=s2>&#34;&#34;&#34;</span><span class=nv>%~nx0</span><span class=s2>&#34;&#34; h&#34;</span>,0)(window.close)<span class=p>&amp;&amp;</span><span class=k>exit</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=nl>begin</span>
</span></span><span class=line><span class=cl>taskkill /T /F /IM wireproxy.exe
</span></span><span class=line><span class=cl>wireproxy.exe -c wireproxy.conf
</span></span><span class=line><span class=cl><span class=k>pause</span>
</span></span></code></pre></td></tr></table></div></div><p>只想 cmd 窗口最小化则可以这么写</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl>taskkill /T /F /IM wireproxy.exe
</span></span><span class=line><span class=cl><span class=k>start</span> /min wireproxy.exe -c wireproxy.conf
</span></span></code></pre></td></tr></table></div></div><h2 id=全自动优选-endpoint>全自动优选 Endpoint</h2><p>不考虑速度，只测试连通性后根据最低延迟优选 Endpoing，半小时跑一遍脚本</p><pre><code>  * */30 * * * /usr/bin/python /home/pi/best_endpiont.py
</code></pre><p>脚本看注释就能懂，工作普遍用第三方库（方便好用）导致写脚本的习惯不太好，以后尽量改成标准库。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># -*- coding:utf-8 -*-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>os.path</span> <span class=kn>import</span> <span class=n>abspath</span><span class=p>,</span> <span class=n>dirname</span><span class=p>,</span> <span class=n>join</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ThreadPoolExecutor</span><span class=p>,</span> <span class=n>as_completed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进程 Process 的创建远远大于线程 Thread 创建占用的资源</span>
</span></span><span class=line><span class=cl><span class=n>MAX_WORKERS</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>LATENCY</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>NODES</span> <span class=o>=</span> <span class=p>[</span><span class=mi>192</span><span class=p>,</span> <span class=mi>193</span><span class=p>,</span> <span class=mi>195</span><span class=p>]</span>  <span class=c1># 有些地区 192 段可能会被墙</span>
</span></span><span class=line><span class=cl><span class=n>REQUEST_TIMEOUT</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;https://1.1.1.1/cdn-cgi/trace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>IP_REG</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&#34;Endpoint = (.*?):2408&#34;</span>
</span></span><span class=line><span class=cl><span class=n>BINDADDRESS_REG</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&#34;BindAddress = 0\.0\.0\.0:\d+&#34;</span>
</span></span><span class=line><span class=cl><span class=n>DIR_DIR</span> <span class=o>=</span> <span class=n>abspath</span><span class=p>(</span><span class=n>dirname</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>BASECONF</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>[Interface]
</span></span></span><span class=line><span class=cl><span class=s2>PrivateKey = kPRKd3QemCiu3NRISPuxkYulex5Pvm91Yz+Sm5R5bFI=
</span></span></span><span class=line><span class=cl><span class=s2>Address = 172.16.0.2/32
</span></span></span><span class=line><span class=cl><span class=s2>DNS = 1.1.1.1
</span></span></span><span class=line><span class=cl><span class=s2>MTU = 1380
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>[Peer]
</span></span></span><span class=line><span class=cl><span class=s2>PublicKey = bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=
</span></span></span><span class=line><span class=cl><span class=s2>AllowedIPs = 0.0.0.0/0
</span></span></span><span class=line><span class=cl><span class=s2>AllowedIPs = ::/0
</span></span></span><span class=line><span class=cl><span class=s2>Endpoint = 162.159.192.1:2408
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>[Socks5]
</span></span></span><span class=line><span class=cl><span class=s2>BindAddress = 0.0.0.0:19000
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_best_endpoint</span><span class=p>(</span><span class=n>mg_dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>best_endpoint</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>mg_dict</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># asc</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>best_endpoint</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_endpoint_configs</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;以随机端口生成各个 IP 段的 wireproxy 配置信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>endpoint_configs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>NODES</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>10000</span><span class=p>,</span> <span class=mi>20000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>socks_port</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=n>BINDADDRESS_REG</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;BindAddress = 0.0.0.0:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>BASECONF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;162\.159\.(.*?):2408&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;162.159.</span><span class=si>{</span><span class=n>node</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>:2408&#34;</span><span class=p>,</span> <span class=n>socks_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>endpoint_configs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 生成文件</span>
</span></span><span class=line><span class=cl>            <span class=n>ip</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>IP_REG</span><span class=p>,</span> <span class=n>data</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>join</span><span class=p>(</span><span class=n>DIR_DIR</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;config/</span><span class=si>{</span><span class=n>ip</span><span class=si>}</span><span class=s2>.conf&#34;</span><span class=p>),</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>endpoint_configs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_latency</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>mg_dict</span><span class=p>,</span> <span class=n>mg_lock</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    从生成的配置文件获取 IP 和 PORT
</span></span></span><span class=line><span class=cl><span class=s2>    IP 作为文件名生成多个配置文件，避免同一文件读写冲突
</span></span></span><span class=line><span class=cl><span class=s2>    Port 作为对应代理端口
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ip</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>IP_REG</span><span class=p>,</span> <span class=n>config</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>BINDADDRESS_REG</span><span class=p>,</span> <span class=n>config</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># [&#34;0.0.0.0&#34;, 19000]</span>
</span></span><span class=line><span class=cl>    <span class=n>dynamic_proxies</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;socks5://127.0.0.1:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;https&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;socks5://127.0.0.1:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>wireproxy</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;/home/pi/bin/wireproxy -d -c </span><span class=si>{</span><span class=n>DIR_DIR</span><span class=si>}</span><span class=s2>/config/</span><span class=si>{</span><span class=n>ip</span><span class=si>}</span><span class=s2>.conf&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                     <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>## stdout.read() 会阻塞</span>
</span></span><span class=line><span class=cl>        <span class=c1># logger.error(f&#34;os.getpid() -&gt; stdout:{wireproxy.stdout.read()}&#34;)</span>
</span></span><span class=line><span class=cl>        <span class=c1># logger.error(f&#34;os.getpid() -&gt; stderr:{wireproxy.stderr.read()}&#34;)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=n>URL</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=n>dynamic_proxies</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>REQUEST_TIMEOUT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>res</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ip: </span><span class=si>{</span><span class=n>ip</span><span class=si>}</span><span class=s2>, elapsed: </span><span class=si>{</span><span class=n>res</span><span class=o>.</span><span class=n>elapsed</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>mg_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>mg_dict</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=n>elapsed</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ip: </span><span class=si>{</span><span class=n>ip</span><span class=si>}</span><span class=s2>, Exception: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>mg_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mg_dict</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>=</span> <span class=mi>999</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>wireproxy</span><span class=o>.</span><span class=n>kill</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rewrite_restart</span><span class=p>(</span><span class=n>best_endpoint</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;覆写本地配置文件再重启服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>BASECONF</span>
</span></span><span class=line><span class=cl>    <span class=c1># wireproxy 配置默认 19000 端口，串联 Clash</span>
</span></span><span class=line><span class=cl>    <span class=n>base</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;Port = \d+&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;Port = 19000&#34;</span><span class=p>,</span> <span class=n>BASECONF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bind_address</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=n>BINDADDRESS_REG</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;BindAddress = 0.0.0.0:19000&#34;</span><span class=p>,</span> <span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ip</span> <span class=o>=</span> <span class=n>best_endpoint</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;Endpoint = (.*?):2408&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;Endpoint = </span><span class=si>{</span><span class=n>ip</span><span class=si>}</span><span class=s2>:2408&#34;</span><span class=p>,</span> <span class=n>bind_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/home/pi/config/wireproxy.conf&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;sudo killall wireproxy&#34;</span><span class=p>],</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;/home/pi/bin/wireproxy -d -c /home/pi/config/wireproxy.conf&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                   <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># windows 在头部引用会触发 spwan error，还需要 freeze_support()</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>multiprocessing</span> <span class=kn>import</span> <span class=n>Manager</span>  <span class=c1># 多进程，大量子进程由 Pool 维护，少量子进程用 Process 比较灵活</span>
</span></span><span class=line><span class=cl>    <span class=c1># 多进程共享变量</span>
</span></span><span class=line><span class=cl>    <span class=n>mg_dict</span> <span class=o>=</span> <span class=n>Manager</span><span class=p>()</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span>  <span class=c1># {ip: latency, ip2: latency2...}</span>
</span></span><span class=line><span class=cl>    <span class=n>mg_lock</span> <span class=o>=</span> <span class=n>Manager</span><span class=p>()</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 多进程封装多变量</span>
</span></span><span class=line><span class=cl>    <span class=n>pt</span> <span class=o>=</span> <span class=n>functools</span><span class=o>.</span><span class=n>partial</span><span class=p>(</span><span class=n>check_latency</span><span class=p>,</span> <span class=n>mg_dict</span><span class=o>=</span><span class=n>mg_dict</span><span class=p>,</span> <span class=n>mg_lock</span><span class=o>=</span><span class=n>mg_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 生成配置文件</span>
</span></span><span class=line><span class=cl>    <span class=n>endpoint_configs</span> <span class=o>=</span> <span class=n>generate_endpoint_configs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 多线程池</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=n>MAX_WORKERS</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>executor</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span> <span class=n>endpoint_configs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 输出结果</span>
</span></span><span class=line><span class=cl>    <span class=n>best_endpoint</span> <span class=o>=</span> <span class=n>get_best_endpoint</span><span class=p>(</span><span class=n>mg_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>DIR_DIR</span><span class=si>}</span><span class=s2>/run.log&#34;</span><span class=p>,</span> <span class=nb>format</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>{time}</span><span class=s2> </span><span class=si>{level}</span><span class=s2> </span><span class=si>{message}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;best_endpoint: </span><span class=si>{</span><span class=n>best_endpoint</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 重启服务</span>
</span></span><span class=line><span class=cl>    <span class=n>rewrite_restart</span><span class=p>(</span><span class=n>best_endpoint</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>至此，一个能用的科学上网备用手段就完全配置好了。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-07-30&nbsp;<a class=git-hash href=https://github.com/sunt-programator/EnjoyIt/commit/052a8c527489728dc504405b26325e23ba146da5 target=_blank rel="noopener noreferrer" title="commit by Evilmass(21218296+Evilmass@users.noreply.github.com) 052a8c527489728dc504405b26325e23ba146da5: local EnjoyIt">
<i class="fas fa-hashtag fa-fw"></i>052a8c5</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/warp/index.md target=_blank rel="noopener noreferrer">Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://evilmass.github.io/posts/warp/ data-title="WARP 作为科学上网备用手段" data-hashtags=warp,zerotrust,wireguard,clash,raspberry><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://evilmass.github.io/posts/warp/ data-hashtag=warp><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://evilmass.github.io/posts/warp/ data-title="WARP 作为科学上网备用手段"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://evilmass.github.io/posts/warp/ data-title="WARP 作为科学上网备用手段"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://evilmass.github.io/posts/warp/ data-title="WARP 作为科学上网备用手段"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/warp/>warp</a>,&nbsp;<a href=/tags/zerotrust/>zerotrust</a>,&nbsp;<a href=/tags/wireguard/>wireguard</a>,&nbsp;<a href=/tags/clash/>clash</a>,&nbsp;<a href=/tags/raspberry/>Raspberry</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/raspbot/ class=prev rel=prev title=我在树莓派上跑了多少服务><i class="fas fa-angle-left fa-fw"></i>我在树莓派上跑了多少服务</a>
<a href=/posts/%E5%86%99%E4%BD%9C%E6%84%8F%E4%B9%89/ class=next rel=next title=写作意义>写作意义<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=busuanzi_container_site_pv>Site PV: <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span></span>
<span class=division>•</span>
<span id=busuanzi_container_site_uv>Site UV: <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span></span></div><div class=footer-line><a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> - <a href=https://github.com/xinyu-yang/EnjoyIt target=_blank rel="noopener noreferrer" title="EnjoyIt 0.0.1"><i class="fas fa-heart fa-fw"></i>EnjoyIt</a><span class=division> •</span>
<i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2023</span>&nbsp;•&nbsp;<span class=license><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{}}</script><script type=text/javascript src=/js/theme.min.d1b26d23ac62a6d4bfafb3292c82d97770d7585d5c60e8d254d46fd9555fc69b.js integrity="sha256-0bJtI6xiptS/r7MpLILZd3DXWF1cYOjSVNRv2VVfxps="></script></body></html>